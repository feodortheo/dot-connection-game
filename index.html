


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dot Connection Game</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection@0.4/face_detection.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .dots-container {
            position: relative;
            width: 90vw;
            max-width: 600px;
            height: 200px;
            margin-bottom: 50px;
        }

        .dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: #ff69b4;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.5s ease;
            box-shadow: 0 0 15px rgba(255, 105, 180, 1), 0 0 30px rgba(255, 105, 180, 0.6);
            z-index: 5;
            border: 2px solid #fff;
        }

        .dot1 {
            /* Position will be set by JavaScript */
        }

        .dot2 {
            /* Position will be set by JavaScript */
        }

        .root {
            position: absolute;
            height: 3px;
            background-color: #ff69b4;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.5s ease;
            box-shadow: 0 0 5px rgba(255, 105, 180, 0.6);
            z-index: 1;
        }

        .root.initial {
            left: 70px;
            right: 70px;
        }

        .root.correct {
            left: 50%;
            right: 50%;
            transform: translateY(-50%) translateX(-50%);
            width: 0;
        }

        .root.incorrect {
            left: 25%;
            right: 25%;
        }

        .buttons {
            display: flex;
            gap: 30px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 18px;
            border: 2px solid #ff69b4;
            background-color: transparent;
            color: #ff69b4;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background-color: #ff69b4;
            color: #000;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .victory-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: transparent;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .victory-text {
            color: #ff69b4;
            font-weight: bold;
            text-shadow: 0 0 20px #ff69b4;
            position: absolute;
            pointer-events: none;
            z-index: 1001;
            will-change: transform, opacity;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        .victory-text.love {
            /* Animation will be set inline for immediate start */
        }

        @keyframes flyAround {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(100vw, -50vh) rotate(90deg);
            }
            50% {
                transform: translate(50vw, 100vh) rotate(180deg);
            }
            75% {
                transform: translate(-50vw, 50vh) rotate(270deg);
            }
            100% {
                transform: translate(0, 0) rotate(360deg);
            }
        }

        @keyframes flyDiagonal {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }
            50% {
                transform: translate(100vw, 100vh) rotate(180deg);
            }
            100% {
                transform: translate(0, 0) rotate(360deg);
            }
        }

        @keyframes flyHorizontal {
            0% {
                transform: translate(-100px, 0) rotate(0deg);
            }
            50% {
                transform: translate(calc(100vw + 100px), 0) rotate(180deg);
            }
            100% {
                transform: translate(-100px, 0) rotate(360deg);
            }
        }

        @keyframes flyVertical {
            0% {
                transform: translate(0, -100px) rotate(0deg);
            }
            50% {
                transform: translate(0, calc(100vh + 100px)) rotate(180deg);
            }
            100% {
                transform: translate(0, -100px) rotate(360deg);
            }
        }

        @keyframes fallDown {
            0% {
                transform: translateY(-200px) rotate(0deg);
                opacity: 1;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh + 200px)) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes fontPulse {
            0% {
                font-size: inherit;
                text-shadow: 0 0 20px #ff69b4;
            }
            50% {
                font-size: 1.3em;
                text-shadow: 0 0 30px #ff69b4, 0 0 40px #ff69b4;
            }
            100% {
                font-size: inherit;
                text-shadow: 0 0 20px #ff69b4;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .heart {
            position: absolute;
            color: #ff69b4;
            font-size: 24px;
            animation: fall 4s linear infinite;
            pointer-events: none;
            text-shadow: 0 0 10px #ff69b4;
            filter: drop-shadow(0 0 5px rgba(255, 105, 180, 0.8));
            z-index: 999;
            will-change: transform, opacity;
            backface-visibility: hidden;
            transform: translateZ(0);
        }

        @keyframes fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .restart-btn {
            padding: 15px 30px;
            font-size: 18px;
            border: 2px solid #ff69b4;
            background-color: #ff69b4;
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            margin-top: 20px;
            text-shadow: 0 0 10px #fff;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.5), 0 0 40px rgba(255, 105, 180, 0.3), 0 0 60px rgba(255, 105, 180, 0.1);
            animation: buttonGlow 2s ease-in-out infinite alternate;
            z-index: 10000;
            position: relative;
        }

        .restart-btn:hover {
            background-color: #ff1493;
            color: #fff;
            text-shadow: 0 0 15px #fff;
            box-shadow: 0 0 30px rgba(255, 20, 147, 0.8), 0 0 60px rgba(255, 20, 147, 0.5), 0 0 90px rgba(255, 20, 147, 0.3);
            transform: scale(1.05);
        }

        .photo-upload-section {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff69b4;
            z-index: 100;
        }

        .photo-upload-section h3 {
            color: #ff69b4;
            margin-bottom: 15px;
            text-align: center;
        }

        .photo-input-group {
            margin-bottom: 15px;
        }

        .photo-input-group label {
            color: #ff69b4;
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .photo-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ff69b4;
            border-radius: 5px;
            background-color: transparent;
            color: #ff69b4;
            font-size: 12px;
        }

        .upload-btn {
            width: 100%;
            padding: 10px;
            background-color: #ff69b4;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background-color: #ff1493;
            transform: scale(1.05);
        }

        .upload-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
            transform: none;
        }

        .person-photo {
            position: absolute;
            width: 100px;
            height: 100px;
            object-fit: cover;
            object-position: center center;
            border: 3px solid #ff69b4;
            border-radius: 50%;
            transition: all 0.5s ease;
            z-index: 10;
        }

        @keyframes headGlow {
            0% {
                filter: drop-shadow(0 0 5px #ff69b4);
            }
            100% {
                filter: drop-shadow(0 0 15px #ff69b4) drop-shadow(0 0 25px rgba(255, 105, 180, 0.5));
            }
        }

        .person-photo.dot1-photo {
            top: -110px;
            left: -50px;
            position: absolute;
            transform: translateZ(0);
        }

        .person-photo.dot2-photo {
            top: -110px;
            right: -50px;
            position: absolute;
            transform: translateZ(0);
        }

        .processing-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .processing-container {
            background-color: #000;
            border: 2px solid #ff69b4;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
        }

        .processing-text {
            color: #ff69b4;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .processing-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ff69b4;
            border-top: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Welcome Screen */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .welcome-text {
            font-size: 32px;
            color: #ff69b4;
            font-weight: bold;
            text-shadow: 0 0 20px #ff69b4;
            margin-bottom: 30px;
            text-align: center;
            animation: welcomePulse 2s ease-in-out infinite;
            line-height: 1.4;
        }

        .welcome-subtitle {
            font-size: 32px;
            color: #ff69b4;
            font-weight: bold;
            text-shadow: 0 0 20px #ff69b4;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.4;
        }

        .welcome-button {
            background-color: #ff69b4;
            color: #fff;
            border: none;
            border-radius: 15px;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.3);
        }

        .welcome-button:hover {
            background-color: #ff1493;
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.5);
        }

        @keyframes welcomePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .butterfly {
            width: 120px;
            height: 80px;
            cursor: pointer;
            animation: butterflyFlyAround 8s ease-in-out infinite;
            transition: all 0.3s ease;
            position: absolute;
            z-index: 1001;
        }

        .butterfly:hover {
            transform: scale(1.1);
        }

        /* Butterfly body */
        .butterfly::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 60px;
            background: linear-gradient(to bottom, #8B4513, #A0522D, #8B4513);
            border-radius: 3px;
            left: 50%;
            top: 10px;
            transform: translateX(-50%);
            box-shadow: 
                0 0 10px rgba(139, 69, 19, 0.5),
                inset 0 0 5px rgba(255, 255, 255, 0.2);
        }

        /* Left wing */
        .butterfly::after {
            content: '';
            position: absolute;
            width: 50px;
            height: 35px;
            background: 
                radial-gradient(circle at 30% 30%, #ff69b4, #ff1493),
                radial-gradient(circle at 70% 20%, #ffc0cb, #ff69b4),
                radial-gradient(circle at 20% 70%, #ff1493, #ff69b4),
                linear-gradient(45deg, #ff69b4, #ff1493, #ff69b4);
            border-radius: 50% 20% 50% 20%;
            left: 0;
            top: 15px;
            transform: rotate(-15deg);
            box-shadow: 
                0 0 15px rgba(255, 105, 180, 0.6),
                inset 0 0 10px rgba(255, 255, 255, 0.3),
                0 0 5px rgba(255, 20, 147, 0.4);
        }

        /* Right wing - using a separate element */
        .butterfly .right-wing {
            position: absolute;
            width: 50px;
            height: 35px;
            background: 
                radial-gradient(circle at 30% 30%, #ff69b4, #ff1493),
                radial-gradient(circle at 70% 20%, #ffc0cb, #ff69b4),
                radial-gradient(circle at 20% 70%, #ff1493, #ff69b4),
                linear-gradient(-45deg, #ff69b4, #ff1493, #ff69b4);
            border-radius: 20% 50% 20% 50%;
            right: 0;
            top: 15px;
            transform: rotate(15deg);
            box-shadow: 
                0 0 15px rgba(255, 105, 180, 0.6),
                inset 0 0 10px rgba(255, 255, 255, 0.3),
                0 0 5px rgba(255, 20, 147, 0.4);
        }

        /* Wing patterns */
        .butterfly .wing-pattern {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #fff, #ffc0cb);
            border-radius: 50%;
            top: 20px;
            left: 15px;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
        }

        .butterfly .wing-pattern:nth-child(2) {
            top: 35px;
            left: 25px;
            width: 6px;
            height: 6px;
        }

        .butterfly .wing-pattern:nth-child(3) {
            top: 25px;
            right: 15px;
            left: auto;
        }

        .butterfly .wing-pattern:nth-child(4) {
            top: 40px;
            right: 25px;
            left: auto;
            width: 6px;
            height: 6px;
        }

        @keyframes butterflyFlyAround {
            0% {
                transform: translate(0vw, 0vh) rotate(0deg);
            }
            12.5% {
                transform: translate(20vw, -10vh) rotate(45deg);
            }
            25% {
                transform: translate(40vw, 5vh) rotate(90deg);
            }
            37.5% {
                transform: translate(60vw, -15vh) rotate(135deg);
            }
            50% {
                transform: translate(80vw, 10vh) rotate(180deg);
            }
            62.5% {
                transform: translate(60vw, 30vh) rotate(225deg);
            }
            75% {
                transform: translate(40vw, 50vh) rotate(270deg);
            }
            87.5% {
                transform: translate(20vw, 30vh) rotate(315deg);
            }
            100% {
                transform: translate(0vw, 0vh) rotate(360deg);
            }
        }

        /* Kissing Screen */
        .kissing-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .kissing-text {
            font-size: 32px;
            color: #ff69b4;
            font-weight: bold;
            text-shadow: 0 0 20px #ff69b4;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.4;
        }

        .kissing-subtitle {
            font-size: 32px;
            color: #ff69b4;
            font-weight: bold;
            text-shadow: 0 0 20px #ff69b4;
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.4;
        }

        /* Fighter Selection Screen */
        .fighter-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .fighter-title {
            font-size: 42px;
            color: #ff69b4;
            font-weight: bold;
            text-shadow: 0 0 20px #ff69b4;
            margin-bottom: 40px;
            text-align: center;
        }

        .fighter-upload-section {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #ff69b4;
            max-width: 500px;
            width: 90%;
        }

        .fighter-upload-section h3 {
            color: #ff69b4;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }

        .fighter-input-group {
            margin-bottom: 20px;
        }

        .fighter-input-group label {
            color: #ff69b4;
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .fighter-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ff69b4;
            border-radius: 8px;
            background-color: transparent;
            color: #ff69b4;
            font-size: 14px;
        }

        .fighter-name-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ff69b4;
            border-radius: 8px;
            background-color: transparent;
            color: #ff69b4;
            font-size: 14px;
            margin-top: 8px;
        }

        .fighter-upload-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }

        .fighter-upload-row .fighter-input-group {
            flex: 1;
            margin-bottom: 0;
        }


        .start-game-btn {
            width: 100%;
            padding: 15px;
            background-color: #ff69b4;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .start-game-btn:hover {
            background-color: #ff1493;
            transform: scale(1.05);
        }

        .start-game-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .dots-container {
                width: 95vw;
                height: 150px;
                margin-bottom: 30px;
            }
            
            .dot {
                width: 18px;
                height: 18px;
            }
            
            .person-photo {
                width: 60px;
                height: 60px;
            }
            
            .person-photo.dot1-photo {
                top: -90px;
                left: -40px;
            }
            
            .person-photo.dot2-photo {
                top: -90px;
                right: -40px;
            }
            
            .welcome-text, .welcome-subtitle, .kissing-text, .kissing-subtitle {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .fighter-title {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .question-header {
                font-size: 20px;
                top: 40px;
            }
            
            .question-display {
                top: 100px;
                font-size: 16px;
                padding: 15px 20px;
                max-width: 90%;
            }
            
            .welcome-button, .start-game-btn {
                padding: 12px 20px;
                font-size: 16px;
            }
            
            /* Statistics screen mobile styles */
            .stats-title {
                font-size: 28px;
                margin-bottom: 30px;
            }
            
            .stats-container {
                gap: 40px;
                flex-direction: column;
            }
            
            .player-photo-stat {
                width: 120px;
                height: 120px;
            }
            
            .player-name-stat {
                font-size: 20px;
            }
            
            .player-percentage {
                font-size: 28px;
            }
            
            .player-details {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .dots-container {
                width: 98vw;
                height: 120px;
                margin-bottom: 20px;
            }
            
            .dot {
                width: 16px;
                height: 16px;
            }
            
            .person-photo {
                width: 50px;
                height: 50px;
            }
            
            .person-photo.dot1-photo {
                top: -75px;
                left: -35px;
            }
            
            .person-photo.dot2-photo {
                top: -75px;
                right: -35px;
            }
            
            .welcome-text, .welcome-subtitle, .kissing-text, .kissing-subtitle {
                font-size: 20px;
                margin-bottom: 15px;
            }
            
            .fighter-title {
                font-size: 20px;
                margin-bottom: 15px;
            }
            
            .question-header {
                font-size: 18px;
                top: 30px;
            }
            
            .question-display {
                top: 80px;
                font-size: 14px;
                padding: 12px 15px;
                max-width: 95%;
            }
            
            /* Statistics screen small mobile styles */
            .stats-title {
                font-size: 24px;
                margin-bottom: 25px;
            }
            
            .stats-container {
                gap: 30px;
            }
            
            .player-photo-stat {
                width: 100px;
                height: 100px;
            }
            
            .player-name-stat {
                font-size: 18px;
            }
            
            .player-percentage {
                font-size: 24px;
            }
            
            .player-details {
                font-size: 12px;
            }
        }

        /* Landscape mobile styles */
        @media (max-height: 500px) and (orientation: landscape) {
            .dots-container {
                height: 100px;
                margin-bottom: 20px;
            }
            
            .person-photo {
                width: 40px;
                height: 40px;
            }
            
            .person-photo.dot1-photo {
                top: -60px;
                left: -30px;
            }
            
            .person-photo.dot2-photo {
                top: -60px;
                right: -30px;
            }
            
            .welcome-text, .welcome-subtitle, .kissing-text, .kissing-subtitle {
                font-size: 18px;
                margin-bottom: 10px;
            }
            
            .question-header {
                font-size: 16px;
                top: 20px;
            }
            
            .question-display {
                top: 60px;
                font-size: 12px;
                padding: 8px 12px;
            }
        }

        /* Game Screen */
        .game-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .question-header {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff69b4;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            text-shadow: 0 0 15px #ff69b4;
            z-index: 1001;
            opacity: 1;
        }

        .question-header.fade-out {
            animation: fadeOut 1s ease-out forwards;
            animation-fill-mode: forwards;
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        .question-display {
            position: absolute;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: #ff69b4;
            padding: 20px 30px;
            border-radius: 15px;
            border: 2px solid #ff69b4;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            max-width: 80%;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.3);
            z-index: 1001;
        }

        /* Answer feedback animations */
        .answer-heart {
            position: absolute;
            font-size: 40px;
            color: #ff69b4;
            pointer-events: none;
            z-index: 1002;
            animation: heartFloat 2s ease-out forwards;
        }

        .answer-broken-heart {
            position: absolute;
            font-size: 40px;
            color: #ff69b4;
            pointer-events: none;
            z-index: 1002;
            animation: brokenHeartFall 2s ease-out forwards;
        }

        @keyframes heartFloat {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(-30px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.8);
            }
        }

        @keyframes brokenHeartFall {
            0% {
                opacity: 1;
                transform: translateY(0px) rotate(0deg) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(20px) rotate(10deg) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(60px) rotate(20deg) scale(0.6);
            }
        }

        /* Kiss animations */
        .kiss-animation {
            position: absolute;
            font-size: 30px;
            color: #ff69b4;
            pointer-events: none;
            z-index: 1002;
            animation: kissFloat 3s ease-out forwards;
        }

        @keyframes kissFloat {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(1) rotate(0deg);
            }
            25% {
                opacity: 1;
                transform: translateY(-20px) scale(1.2) rotate(10deg);
            }
            50% {
                opacity: 1;
                transform: translateY(-40px) scale(1.1) rotate(-5deg);
            }
            75% {
                opacity: 0.7;
                transform: translateY(-60px) scale(0.9) rotate(15deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(0.7) rotate(25deg);
            }
        }

        .question-mark-animation {
            font-size: 30px;
            color: #ff69b4;
            position: absolute;
            pointer-events: none;
            z-index: 1002;
            animation: questionMarkFloat 2s ease-out forwards;
        }

        @keyframes questionMarkFloat {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(1) rotate(0deg);
            }
            25% {
                opacity: 1;
                transform: translateY(-20px) scale(1.2) rotate(10deg);
            }
            50% {
                opacity: 1;
                transform: translateY(-40px) scale(1.1) rotate(-5deg);
            }
            75% {
                opacity: 0.7;
                transform: translateY(-60px) scale(0.9) rotate(15deg);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(0.7) rotate(25deg);
            }
        }

        /* Background Music */
        #backgroundMusic {
            display: none;
        }

        /* Music Player */
        .music-player {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 25px;
            padding: 8px;
            z-index: 2000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            overflow: hidden;
            width: 50px;
            height: 50px;
        }

        .music-player:hover {
            width: auto;
            height: auto;
            padding: 10px;
        }

        .music-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            color: #ff69b4;
            transition: all 0.3s ease;
        }

        .music-player:hover .music-icon {
            opacity: 0;
        }

        .music-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .music-player:hover .music-controls {
            opacity: 1;
        }

        .music-btn {
            background: #ff69b4;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .music-btn:hover {
            background: #ff1493;
            transform: scale(1.1);
        }

        .track-info {
            display: flex;
            flex-direction: column;
            margin-left: 8px;
            color: white;
            font-size: 12px;
            min-width: 100px;
        }

        #trackTitle {
            font-weight: bold;
            color: #ff69b4;
        }

        #trackNumber {
            font-size: 10px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .music-player {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
            
            .music-icon {
                font-size: 28px;
            }
            
            .music-btn {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }
            
            .track-info {
                font-size: 10px;
                min-width: 80px;
            }
            
            #trackNumber {
                font-size: 9px;
            }
        }

        /* End Screen */
        .end-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .end-text {
            font-size: 36px;
            color: #ff69b4;
            font-weight: bold;
            text-shadow: 0 0 20px #ff69b4;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Statistics Screen */
        .stats-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .stats-title {
            font-size: 42px;
            color: #ff69b4;
            font-weight: bold;
            text-shadow: 0 0 20px #ff69b4;
            margin-bottom: 50px;
            text-align: center;
        }

        .stats-container {
            display: flex;
            gap: 80px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }

        .player-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .player-photo-stat {
            width: 150px;
            height: 150px;
            object-fit: cover;
            object-position: center center;
            border: 4px solid #ff69b4;
            border-radius: 50%;
            margin-bottom: 20px;
            box-shadow: 0 0 30px rgba(255, 105, 180, 0.5);
            animation: headGlow 2s ease-in-out infinite alternate;
        }

        .player-name-stat {
            font-size: 24px;
            color: #ff69b4;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #ff69b4;
        }

        .player-percentage {
            font-size: 36px;
            color: #ff69b4;
            font-weight: bold;
            text-shadow: 0 0 15px #ff69b4;
            margin-bottom: 10px;
        }

        .player-details {
            font-size: 16px;
            color: #ff69b4;
            opacity: 0.8;
        }

        .stats-restart-btn {
            margin-top: 50px;
        }

        @keyframes buttonGlow {
            0% {
                box-shadow: 0 0 20px rgba(255, 105, 180, 0.5), 0 0 40px rgba(255, 105, 180, 0.3), 0 0 60px rgba(255, 105, 180, 0.1);
                text-shadow: 0 0 10px #fff;
            }
            100% {
                box-shadow: 0 0 30px rgba(255, 105, 180, 0.7), 0 0 60px rgba(255, 105, 180, 0.4), 0 0 90px rgba(255, 105, 180, 0.2);
                text-shadow: 0 0 15px #fff, 0 0 25px #fff;
            }
        }
    </style>
</head>
<body>
    <!-- Background Music -->
    <audio id="backgroundMusic" loop preload="auto">
        <source src="https://www.bensound.com/bensound-music/bensound-pianomoment.mp3" type="audio/mpeg">
        <source src="https://www.bensound.com/bensound-music/bensound-pianomoment.ogg" type="audio/ogg">
        Your browser does not support the audio element.
    </audio>
    
    <!-- Music Player -->
    <div id="musicPlayer" class="music-player">
        <div class="music-icon">♪</div>
        <div class="music-controls">
            <button id="prevTrack" class="music-btn">⏮</button>
            <button id="playPause" class="music-btn">▶</button>
            <button id="nextTrack" class="music-btn">⏭</button>
            <div class="track-info">
                <span id="trackTitle">Момент пианино</span>
            </div>
        </div>
    </div>
    
    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-text">привет, дорогуши</div>
        <div class="welcome-subtitle">я сделал игру, чтобы проверить, насколько хорошо вы знаете друг друга</div>
        <div class="welcome-subtitle">готовы?</div>
        <button class="welcome-button" onclick="showKissingScreenWithHearts()">да</button>
    </div>

    <!-- Kissing Screen -->
    <div class="kissing-screen" id="kissingScreen">
        <div class="kissing-text" id="kissingText">для начала нужно поцеловаться</div>
        <button class="welcome-button" id="kissButton" onclick="showQuestionAndButton()">мы поцеловались</button>
    </div>

    <!-- Fighter Selection Screen -->
    <div class="fighter-screen" id="fighterScreen">
        <div class="fighter-title">выберите ваших бойцов</div>
        <div class="fighter-upload-section">
            <div class="fighter-upload-row">
                <div class="fighter-input-group">
                    <label for="fighter1">Боец 1:</label>
                    <input type="file" id="fighter1" class="fighter-input" accept="image/*" onchange="handleFighterUpload(1, this)">
                    <input type="text" id="name1" class="fighter-name-input" placeholder="Введите имя" onchange="updateFighterName(1, this)">
                </div>
                <div class="fighter-input-group">
                    <label for="fighter2">Боец 2:</label>
                    <input type="file" id="fighter2" class="fighter-input" accept="image/*" onchange="handleFighterUpload(2, this)">
                    <input type="text" id="name2" class="fighter-name-input" placeholder="Введите имя" onchange="updateFighterName(2, this)">
                </div>
            </div>
            <button class="start-game-btn" onclick="beginGame()" id="startGameBtn" disabled>Введите имена обоих бойцов</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div class="game-screen" id="gameScreen">
        <div class="question-header" id="questionHeader"></div>
        <div class="question-display" id="questionDisplay"></div>
        <div class="container">
            <div class="dots-container">
                <div class="dot dot1">
                    <img id="person1" class="person-photo dot1-photo" style="display: none;" alt="Person 1">
                </div>
                <div class="dot dot2">
                    <img id="person2" class="person-photo dot2-photo" style="display: none;" alt="Person 2">
                </div>
                <div class="root initial"></div>
            </div>
            
            <div class="buttons">
                <button class="btn" onclick="moveDots('correct')">Правильно</button>
                <button class="btn" onclick="moveDots('incorrect')">Неправильно</button>
            </div>
        </div>
    </div>

    <!-- End Screen -->
    <div class="end-screen" id="endScreen">
        <div class="end-text">Игра завершена!</div>
        <button class="restart-btn" onclick="restartFromBeginning()">Играть снова</button>
    </div>

    <!-- Victory Screen -->
    <div class="victory-screen" id="victoryScreen">
        <button class="restart-btn" onclick="showStatsScreen()">Показать статистику</button>
    </div>

    <!-- Statistics Screen -->
    <div class="stats-screen" id="statsScreen">
        <div class="stats-title">Статистика игроков</div>
        <div class="stats-container">
            <div class="player-stat">
                <img id="player1StatPhoto" class="player-photo-stat" alt="Player 1">
                <div id="player1StatName" class="player-name-stat"></div>
                <div id="player1StatPercentage" class="player-percentage"></div>
                <div id="player1StatDetails" class="player-details"></div>
            </div>
            <div class="player-stat">
                <img id="player2StatPhoto" class="player-photo-stat" alt="Player 2">
                <div id="player2StatName" class="player-name-stat"></div>
                <div id="player2StatPercentage" class="player-percentage"></div>
                <div id="player2StatDetails" class="player-details"></div>
            </div>
        </div>
        <button class="restart-btn stats-restart-btn" onclick="restartFromBeginning()">Играть снова</button>
    </div>

    <!-- Processing Modal -->
    <div class="processing-modal" id="processingModal">
        <div class="processing-container">
            <div class="processing-spinner"></div>
            <div class="processing-text" id="processingText">Обнаружение лиц...</div>
        </div>
    </div>

    <script>
        // Background Music Setup
        document.addEventListener('DOMContentLoaded', function() {
            const backgroundMusic = document.getElementById('backgroundMusic');
            const playPauseBtn = document.getElementById('playPause');
            const prevTrackBtn = document.getElementById('prevTrack');
            const nextTrackBtn = document.getElementById('nextTrack');
            const trackTitle = document.getElementById('trackTitle');
            
            // 50 romantic and relaxing music tracks
            const musicTracks = [
                { title: "Момент пианино", url: "https://www.bensound.com/bensound-music/bensound-pianomoment.mp3" },
                { title: "Мирный разум", url: "https://www.bensound.com/bensound-music/bensound-peaceful.mp3" },
                { title: "Нежный ветерок", url: "https://www.bensound.com/bensound-music/bensound-gentle.mp3" },
                { title: "Сладкие сны", url: "https://www.bensound.com/bensound-music/bensound-sweet.mp3" },
                { title: "Нежные моменты", url: "https://www.bensound.com/bensound-music/bensound-tender.mp3" },
                { title: "Тихий шёпот", url: "https://www.bensound.com/bensound-music/bensound-soft.mp3" },
                { title: "Струны сердца", url: "https://www.bensound.com/bensound-music/bensound-heart.mp3" },
                { title: "Лунная романтика", url: "https://www.bensound.com/bensound-music/bensound-moonlight.mp3" },
                { title: "Океанская безмятежность", url: "https://www.bensound.com/bensound-music/bensound-ocean.mp3" },
                { title: "Лесная гармония", url: "https://www.bensound.com/bensound-music/bensound-forest.mp3" },
                { title: "Утренняя радость", url: "https://www.bensound.com/bensound-music/bensound-morning.mp3" },
                { title: "Вечерняя романтика", url: "https://www.bensound.com/bensound-music/bensound-evening.mp3" },
                { title: "Весенняя любовь", url: "https://www.bensound.com/bensound-music/bensound-summer.mp3" },
                { title: "Золотая осень", url: "https://www.bensound.com/bensound-music/bensound-autumn.mp3" },
                { title: "Зимнее чудо", url: "https://www.bensound.com/bensound-music/bensound-winter.mp3" },
                { title: "Кристальная любовь", url: "https://www.bensound.com/bensound-music/bensound-crystal.mp3" },
                { title: "Золотой час", url: "https://www.bensound.com/bensound-music/bensound-golden.mp3" },
                { title: "Серебряная романтика", url: "https://www.bensound.com/bensound-music/bensound-silver.mp3" },
                { title: "Голубая романтика", url: "https://www.bensound.com/bensound-music/bensound-blue.mp3" },
                { title: "Зелёный рай", url: "https://www.bensound.com/bensound-music/bensound-green.mp3" },
                { title: "Белая романтика", url: "https://www.bensound.com/bensound-music/bensound-white.mp3" },
                { title: "Элегантная любовь", url: "https://www.bensound.com/bensound-music/bensound-black.mp3" },
                { title: "Розовая романтика", url: "https://www.bensound.com/bensound-music/bensound-pink.mp3" },
                { title: "Оранжевая радость", url: "https://www.bensound.com/bensound-music/bensound-orange.mp3" },
                { title: "Жёлтое счастье", url: "https://www.bensound.com/bensound-music/bensound-yellow.mp3" },
                { title: "Индиго романтика", url: "https://www.bensound.com/bensound-music/bensound-indigo.mp3" },
                { title: "Бирюзовая любовь", url: "https://www.bensound.com/bensound-music/bensound-turquoise.mp3" },
                { title: "Коралловая романтика", url: "https://www.bensound.com/bensound-music/bensound-coral.mp3" },
                { title: "Лавандовая любовь", url: "https://www.bensound.com/bensound-music/bensound-lavender.mp3" },
                { title: "Свежая мятная любовь", url: "https://www.bensound.com/bensound-music/bensound-mint.mp3" },
                { title: "Персиковая романтика", url: "https://www.bensound.com/bensound-music/bensound-peach.mp3" },
                { title: "Розовый сад", url: "https://www.bensound.com/bensound-music/bensound-rose.mp3" },
                { title: "Лилейная любовь", url: "https://www.bensound.com/bensound-music/bensound-lily.mp3" },
                { title: "Ромашковая романтика", url: "https://www.bensound.com/bensound-music/bensound-daisy.mp3" },
                { title: "Тюльпановая любовь", url: "https://www.bensound.com/bensound-music/bensound-tulip.mp3" },
                { title: "Подсолнечная радость", url: "https://www.bensound.com/bensound-music/bensound-sunflower.mp3" },
                { title: "Орхидейная романтика", url: "https://www.bensound.com/bensound-music/bensound-orchid.mp3" },
                { title: "Жасминовая любовь", url: "https://www.bensound.com/bensound-music/bensound-jasmine.mp3" },
                { title: "Лотосовая романтика", url: "https://www.bensound.com/bensound-music/bensound-lotus.mp3" },
                { title: "Магнолиевая любовь", url: "https://www.bensound.com/bensound-music/bensound-magnolia.mp3" },
                { title: "Вишнёвая романтика", url: "https://www.bensound.com/bensound-music/bensound-cherry.mp3" },
                { title: "Яблочная любовь", url: "https://www.bensound.com/bensound-music/bensound-apple.mp3" },
                { title: "Грушевая романтика", url: "https://www.bensound.com/bensound-music/bensound-pear.mp3" },
                { title: "Сливовая любовь", url: "https://www.bensound.com/bensound-music/bensound-plum.mp3" },
                { title: "Виноградная романтика", url: "https://www.bensound.com/bensound-music/bensound-grape.mp3" },
                { title: "Клубничная любовь", url: "https://www.bensound.com/bensound-music/bensound-strawberry.mp3" },
                { title: "Малиновая романтика", url: "https://www.bensound.com/bensound-music/bensound-raspberry.mp3" },
                { title: "Черничная любовь", url: "https://www.bensound.com/bensound-music/bensound-blueberry.mp3" },
                { title: "Клюквенная романтика", url: "https://www.bensound.com/bensound-music/bensound-cranberry.mp3" },
                { title: "Апельсиновая любовь", url: "https://www.bensound.com/bensound-music/bensound-orange.mp3" },
                { title: "Лимонная романтика", url: "https://www.bensound.com/bensound-music/bensound-lemon.mp3" },
                { title: "Лаймовая любовь", url: "https://www.bensound.com/bensound-music/bensound-lime.mp3" },
                { title: "Грейпфрутовая романтика", url: "https://www.bensound.com/bensound-music/bensound-grapefruit.mp3" }
            ];
            
            let currentTrackIndex = 0;
            let isPlaying = false;
            let playedTracks = new Set(); // Track which tracks have been played
            
            // Get random track index
            function getRandomTrackIndex() {
                // If all tracks have been played, reset the set
                if (playedTracks.size >= musicTracks.length) {
                    playedTracks.clear();
                }
                
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * musicTracks.length);
                } while (playedTracks.has(randomIndex));
                
                playedTracks.add(randomIndex);
                return randomIndex;
            }

            // Load current track with error handling
            function loadTrack(index) {
                const track = musicTracks[index];
                backgroundMusic.src = track.url;
                trackTitle.textContent = track.title;
                
                // Add error handling for failed track loading
                backgroundMusic.addEventListener('error', function() {
                    console.log(`Failed to load track: ${track.title}`);
                    // Try next track if current fails
                    setTimeout(() => {
                        nextTrack();
                    }, 1000);
                }, { once: true });
            }
            
            // Play music with better error handling
            function playMusic() {
                backgroundMusic.volume = 0.15;
                
                // Try to play the current track
                const playPromise = backgroundMusic.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                    isPlaying = true;
                    playPauseBtn.textContent = '⏸';
                        console.log(`Now playing: ${musicTracks[currentTrackIndex].title}`);
                }).catch(function(error) {
                    console.log('Play prevented:', error);
                        // Try to load and play next track
                        console.log('Trying next track...');
                        nextTrack();
                });
                }
            }
            
            // Pause music
            function pauseMusic() {
                backgroundMusic.pause();
                isPlaying = false;
                playPauseBtn.textContent = '▶';
            }
            
            // Next track (random)
            function nextTrack() {
                currentTrackIndex = getRandomTrackIndex();
                loadTrack(currentTrackIndex);
                if (isPlaying) {
                    setTimeout(() => {
                    playMusic();
                    }, 500); // Small delay to ensure track is loaded
                }
            }
            
            // Previous track (random)
            function prevTrack() {
                currentTrackIndex = getRandomTrackIndex();
                loadTrack(currentTrackIndex);
                if (isPlaying) {
                    setTimeout(() => {
                    playMusic();
                    }, 500); // Small delay to ensure track is loaded
                }
            }
            
            // Event listeners
            playPauseBtn.addEventListener('click', function() {
                if (isPlaying) {
                    pauseMusic();
                } else {
                    playMusic();
                }
            });
            
            nextTrackBtn.addEventListener('click', nextTrack);
            prevTrackBtn.addEventListener('click', prevTrack);
            
            // Auto play next track when current ends
            backgroundMusic.addEventListener('ended', nextTrack);
            
            // Initialize with random track
            currentTrackIndex = getRandomTrackIndex();
            loadTrack(currentTrackIndex);
            
            // Try to play music when user first interacts with the page
            function playBackgroundMusic() {
                if (!isPlaying) {
                    console.log('Attempting to play background music...');
                    // Ensure we have a valid track loaded
                    if (!backgroundMusic.src) {
                        loadTrack(currentTrackIndex);
                    }
                    setTimeout(() => {
                    playMusic();
                    }, 200);
                }
            }
            
            // Play music on first user interaction
            document.addEventListener('click', playBackgroundMusic, { once: true });
            document.addEventListener('touchstart', playBackgroundMusic, { once: true });
            document.addEventListener('keydown', playBackgroundMusic, { once: true });
            
            // Also try to play music when welcome button is clicked
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('welcome-button')) {
                    console.log('Welcome button clicked, trying to play music...');
                    setTimeout(playBackgroundMusic, 100);
                }
            });
            
            // Try to play music when any button is clicked
            document.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON' && !isPlaying) {
                    console.log('Button clicked, trying to play music...');
                    setTimeout(playBackgroundMusic, 50);
                }
            });
            
            // Add visual feedback for music player
            function updateMusicPlayerUI() {
                if (isPlaying) {
                    playPauseBtn.textContent = '⏸';
                    playPauseBtn.style.backgroundColor = '#ff69b4';
                } else {
                    playPauseBtn.textContent = '▶';
                    playPauseBtn.style.backgroundColor = '#ff69b4';
                }
            }
        });

        let currentDistance = 20; // Total path length starts at 20
        const maxDistance = 20;
        const minDistance = 0;
        let uploadedPhotos = { photo1: null, photo2: null };
        let fighterNames = { name1: '', name2: '' };
        let faceDetector = null;
        let currentScreen = 'welcome';
        let currentQuestion = '';
        let currentQuestionIndex = 0; // To alternate between names
        let headerFadeTimeout = null;
        let questionMarkInterval = null;
        
        // Statistics tracking
        let playerStats = {
            player1: { correct: 0, total: 0, name: '' },
            player2: { correct: 0, total: 0, name: '' }
        };

        // Function to decline names properly in Russian
        function declineName(name, caseType = 'genitive') {
            if (!name || name.length < 2) return name;
            
            const nameLower = name.toLowerCase();
            const lastChar = nameLower.slice(-1);
            const secondLastChar = nameLower.slice(-2, -1);
            
            // Simple declension rules for common Russian names
            switch (caseType) {
                case 'genitive': // кого? чего?
                    if (lastChar === 'а' || lastChar === 'я') {
                        return name.slice(0, -1) + (lastChar === 'а' ? 'ы' : 'и');
                    } else if (lastChar === 'ь' || lastChar === 'й') {
                        return name.slice(0, -1) + 'я';
                    } else if (lastChar === 'о' || lastChar === 'е') {
                        return name.slice(0, -1) + 'а';
                    } else {
                        return name + 'а';
                    }
                case 'dative': // кому? чему?
                    if (lastChar === 'а' || lastChar === 'я') {
                        return name.slice(0, -1) + (lastChar === 'а' ? 'е' : 'е');
                    } else if (lastChar === 'ь' || lastChar === 'й') {
                        return name.slice(0, -1) + 'ю';
                    } else if (lastChar === 'о' || lastChar === 'е') {
                        return name.slice(0, -1) + 'у';
                    } else {
                        return name + 'у';
                    }
                case 'accusative': // кого? что?
                    if (lastChar === 'а' || lastChar === 'я') {
                        return name.slice(0, -1) + (lastChar === 'а' ? 'у' : 'ю');
                    } else if (lastChar === 'ь' || lastChar === 'й') {
                        return name.slice(0, -1) + 'я';
                    } else if (lastChar === 'о' || lastChar === 'е') {
                        return name.slice(0, -1) + 'о';
                    } else {
                        return name + 'а';
                    }
                case 'instrumental': // кем? чем?
                    if (lastChar === 'а' || lastChar === 'я') {
                        return name.slice(0, -1) + (lastChar === 'а' ? 'ой' : 'ей');
                    } else if (lastChar === 'ь' || lastChar === 'й') {
                        return name.slice(0, -1) + 'ем';
                    } else if (lastChar === 'о' || lastChar === 'е') {
                        return name.slice(0, -1) + 'ом';
                    } else {
                        return name + 'ом';
                    }
                case 'prepositional': // о ком? о чём?
                    if (lastChar === 'а' || lastChar === 'я') {
                        return name.slice(0, -1) + (lastChar === 'а' ? 'е' : 'е');
                    } else if (lastChar === 'ь' || lastChar === 'й') {
                        return name.slice(0, -1) + 'е';
                    } else if (lastChar === 'о' || lastChar === 'е') {
                        return name.slice(0, -1) + 'е';
                    } else {
                        return name + 'е';
                    }
                default:
                    return name;
            }
        }

        // Function to replace "партнёр" with properly declined name
        function personalizeQuestion(question, name) {
            if (!name) return question;
            
            // Replace different forms of "партнёр" with properly declined name
            let personalizedQuestion = question;
            
            // Replace "партнёр" (nominative) with name in nominative
            personalizedQuestion = personalizedQuestion.replace(/партнёр/g, name);
            
            // Replace "партнёра" (genitive/accusative) with declined name
            personalizedQuestion = personalizedQuestion.replace(/партнёра/g, declineName(name, 'genitive'));
            
            // Replace "партнёру" (dative) with declined name
            personalizedQuestion = personalizedQuestion.replace(/партнёру/g, declineName(name, 'dative'));
            
            // Replace "партнёром" (instrumental) with declined name
            personalizedQuestion = personalizedQuestion.replace(/партнёром/g, declineName(name, 'instrumental'));
            
            // Replace "партнёре" (prepositional) with declined name
            personalizedQuestion = personalizedQuestion.replace(/партнёре/g, declineName(name, 'prepositional'));
            
            return personalizedQuestion;
        }
        
        // Array of deep personal questions
        const questions = [
            "Кого бы пригласил партнёр выпить пива, если бы мог пригласить любого человека из любой эпохи?",
            "Хотел бы партнёр быть очень известным? Например, как Мистер Бист?",
            "Каким представляет партнёр свой идеальный день?",
            "Какие три качества партнёр считает общими у вас двоих?",
            "Что партнёр хотел бы изменить в своём детстве?",
            "Какую суперспособность хотел бы иметь партнёр больше всего?",
            "Согласился бы партнёр узнать дату и время своей смерти, если бы была такая возможность?",
            "Какое своё достижение партнёр считает самым большим?",
            "Какое воспоминание партнёра самое ценное?",
            "Какое воспоминание для партнёра самое болезненное?",
            "Что изменил бы партнёр в жизни, если бы знал, что умрёт через год?",
            "Считает ли партнёр своё детство более счастливым, чем у других?",
            "Какой самый стыдный случай был у партнёра?",
            "Когда партнёр в последний раз плакал перед кем-то? А в одиночестве?",
            "О чём партнёр пожалел бы больше всего, если бы умер сегодня?",
            "Что партнёр вынес бы из горящего дома (кроме близких и питомцев)?",
            "Чью смерть в семье партнёр пережил бы тяжелее всего и почему?",
            "Насколько по шкале от 1 до 10 партнёр верит в Бога?",
            "Что, по мнению партнёра, происходит после смерти?",
            "Верит ли партнёр в реинкарнацию?",
            "Верит ли партнёр в рай или ад?",
            "Думает ли партнёр, что существуют призраки?",
            "Верит ли партнёр в инопланетян?",
            "Верит ли партнёр в НЛО?",
            "Верит ли партнёр в паранормальное?",
            "Верит ли партнёр в астрологию?",
            "Что находится на краю вселенной — по мнению партнёра?",
            "Как, по мнению партнёра, закончится мир?",
            "На какую планету переселился бы партнёр?",
            "Думал ли когда-то партнёр о совершении суицида?",
            "Какой любимый бренд одежды у партнёра?",
            "Какие 3 бренда одежды партнёр никогда бы не надел?",
            "Какое любимое блюдо партнёра?",
            "Что партнёру больше нравится: перемещаться на поезде или самолёте?",
            "Каким животным был бы партнёр, если бы мог выбирать?",
            "Кем был бы партнёр из Смешариков?",
            "Боится ли партнёр змей?",
            "Боится ли партнёр высоты?",
            "Боится ли партнёр пауков?",
            "Кто любимый рэпер партнёра?",
            "На чей концерт партнёр мечтает сходить больше всего?",
            "Какую машину купил бы партнёр?",
            "Сколько книг прочитал партнёр за прошедший год?",
            "Какой любимый фильм партнёра?",
            "Какой любимый алкогольный напиток у партнёра?",
            "Любимый анекдот партнёра?",
            "Любимый блогер партнёра?",
            "Какое искусство партнёр считает любимым и почему?",
            "Чего больше всего боится партнёр?",
            "Какая любимая игрушка была у партнёра в детстве?",
            "Кто был лучшим другом партнёра в школе?",
            "Какая была кличка у партнёра в школе?",
            "Кем партнёр хотел стать в детстве?",
            "В чём, по мнению партнёра, сильнее всего травмировали родители?",
            "Какой период был для партнёра самым тяжёлым?",
            "Какой лучший совет партнёр получил от родителей?",
            "Какие нездоровые привычки перенял партнёр от семьи?",
            "Как воспитывали партнёра? Какими были его родители?",
            "Есть ли у партнёра детские или взрослые травмы, которые повлияли на него?",
            "Какое воспоминание о вас двоих самое дорогое у партнёра?",
            "Врал ли когда-то партнёр вам?",
            "Что сложнее всего сказать партнёру вам?",
            "В какой ситуации партнёр чувствует себя уязвимым рядом с вами?",
            "Что его больше всего пугает в отношениях?",
            "Предавал ли партнёр когда-то близкого человека?",
            "Испытывал ли партнёр предательство от тех, кому доверял?",
            "Какой у партнёра язык любви?",
            "Какой у партнёра тип привязанности?",
            "Что партнёр узнал из своих прошлых романтических отношений?",
            "Как партнёр относится к браку?",
            "Считает ли партнёр, что важно прощать?",
            "Как партнёр справляется с конфликтами?",
            "Готов ли партнёр идти на парную терапию, если возникнут проблемы?",
            "Что партнёр больше всего ценит в дружбе?",
            "Что больше всего любят друзья партнёра в нём?",
            "Какая у партнёра главная жизненная цель?",
            "Каким партнёр представляет идеальный дом?",
            "Где партнёр хотел бы жить?",
            "Каким партнёр видит идеальный отпуск?",
            "Сколько детей хотел бы партнёр?",
            "Где партнёр видит себя через 5-10 лет?",
            "Хочет ли партнёр детей или домашних животных? Если да, то сколько?",
            "Какие имена для детей выбрал бы партнёр?",
            "Какая у партнёра нереализованная сексуальная фантазия?",
            "Как часто партнёр хочет заниматься сексом?",
            "Какие у партнёра привычки сна?",
            "Что для партнёра означает «чистый дом»?",
            "Как партнёр управляет финансами и долгами?",
            "Есть ли у партнёра долги?",
            "Может ли партнёр иметь друзей противоположного пола?",
            "Насколько по шкале от 1 до 10 партнёр считает себя привлекательным?",
            "Чем партнёр больше всего гордится в себе?",
            "Какой самый странный талант есть у партнёра?",
            "Что бы выбрал партнёр: навсегда говорить голосом тиктокерши из озвучек или смеяться только как злобный мультяшный скелет?",
            "Что бы выбрал партнёр: руки-селфи-палки или ноги-гироскутеры, которые сами едут, куда хотят?",
            "Что бы выбрал партнёр: вместо волос иметь лапшу Доширак или вместо бороды кусочки скотча, которые всё время липнут?",
            "Что бы выбрал партнёр: при каждом поцелуе звучала бы песня «Владимирский централ» или каждый раз при ссоре включался бы детский смех из хоррора?",
            "Что бы выбрал партнёр: пальцы в виде USB-флешек или нос-пипетку, из которой всегда капает вода?",
            "Что бы выбрал партнёр: всегда ходить в Crocs со встроенными гирляндами или всю жизнь носить шапку в форме арбуза?",
            "Что бы выбрал партнёр: язык-губку для мытья посуды или зубы, которые всегда выстроены в слово «LOL»?",
            "Что бы выбрал партнёр: голос Siri, но с задержкой в 5 секунд, или смех как у Патрика из «Спанч Боба»?",
            "Что бы выбрал партнёр: вместо бровей иметь две маленькие гусеницы или вместо ушей мини-кастрюли?",
            "Что бы выбрал партнёр: каждый раз, когда он злится, на лбу появляется надпись «Ошибка 404» или при радости загорается надпись «Loading…»?",
            "Что бы выбрал партнёр: никогда не целоваться или никогда не обниматься?",
            "С какой своей версией из параллельной вселенной хотел бы встретиться партнёр?",
            "Полюбил бы партнёр вас, если бы вы превратились в медведя?",
            "Что партнёр сделал бы первым делом в зомби-апокалипсисе?",
            "Какое оружие выбрал бы партнёр в зомби-апокалипсисе?",
            "Что сделал бы партнёр, если бы узнал, что он сын Павла Дурова?",
            "В какое время и место в прошлом отправился бы партнёр и какой артефакт привёз бы с собой?",
            "Как бы партнёр отреагировал на встречу с инопланетянином?",
            "Встретившись с Путиным, что сказал бы ему партнёр?",
            "Каким животным стал бы партнёр на один день?",
            "Есть ли у партнёра знакомые, которые убивали людей?",
            "Убивал ли партнёр когда-нибудь животное?",
            "Любит ли партнёр рыбалку?",
            "Как правильно вешать туалетную бумагу — сверху или снизу, по мнению партнёра?",
            "Какие семейные тайны знает партнёр?",
            "Какая у партнёра самая большая боязнь?",
            "О чём партнёр больше всего жалеет?",
            "Какое самое худшее, что партнёр когда-либо делал по отношению к другому человеку? Как он относится к этому сегодня?"
        ];
        
        function moveDots(action) {
            const dot1 = document.querySelector('.dot1');
            const dot2 = document.querySelector('.dot2');
            const root = document.querySelector('.root');
            
            // Determine which player answered (alternating)
            const currentPlayer = currentQuestionIndex % 2 === 0 ? 'player1' : 'player2';
            playerStats[currentPlayer].total++;
            
            if (action === 'correct') {
                // Move dots 1 unit closer
                currentDistance = Math.max(minDistance, currentDistance - 1);
                // Show heart animation
                showAnswerAnimation('heart');
                // Update stats
                playerStats[currentPlayer].correct++;
            } else if (action === 'incorrect') {
                // Move dots 0.5 units apart
                currentDistance = Math.min(maxDistance, currentDistance + 0.5);
                // Show broken heart animation
                showAnswerAnimation('broken-heart');
            }
            
            updateDotPositions();
            updateScoreDisplay();
            
            // Change question after each answer
            showRandomQuestion();
            
            // Check for victory condition
            if (currentDistance <= 0) {
                showVictoryScreen();
            }
        }
        
        function updateDotPositions() {
            const dot1 = document.querySelector('.dot1');
            const dot2 = document.querySelector('.dot2');
            const root = document.querySelector('.root');
            const container = document.querySelector('.dots-container');
            
            // Calculate positions based on current distance
            // Use actual container width for responsive design
            const containerWidth = container.offsetWidth;
            const dotSize = 20;
            const availableWidth = containerWidth - dotSize;
            
            // Convert distance to percentage
            const distancePercentage = (currentDistance / maxDistance) * 100;
            const leftPosition = (100 - distancePercentage) / 2;
            const rightPosition = leftPosition;
            
            // Update dot positions
            dot1.style.left = `${leftPosition}%`;
            dot2.style.right = `${rightPosition}%`;
            
            // Update root line
            root.style.left = `${leftPosition + 1}%`;
            root.style.right = `${rightPosition + 1}%`;
            
            // Remove any existing classes
            root.classList.remove('initial', 'correct', 'incorrect');
            
            if (currentDistance <= 0) {
                root.classList.add('correct');
            } else {
                root.classList.add('initial');
            }
        }
        
        function updateScoreDisplay() {
            let scoreElement = document.querySelector('.score-display');
            if (!scoreElement) {
                scoreElement = document.createElement('div');
                scoreElement.className = 'score-display';
                scoreElement.style.cssText = `
                    position: absolute;
                    top: 20px;
                    left: 20px;
                    color: #ff69b4;
                    font-size: 18px;
                    font-weight: bold;
                `;
                document.querySelector('.container').appendChild(scoreElement);
            }
            
            const progress = ((maxDistance - currentDistance) / maxDistance * 100).toFixed(1);
            scoreElement.textContent = `Progress: ${progress}%`;
        }

        function showVictoryScreen() {
            // Hide game screen and show victory screen
            showScreen('victory');
            createVictoryTexts();
            startHeartAnimation();
        }
        
        function createVictoryTexts() {
            const victoryScreen = document.getElementById('victoryScreen');
            
            // Create 40 "love" texts and make them fall immediately
            for (let i = 0; i < 40; i++) {
                const loveText = document.createElement('div');
                loveText.className = 'victory-text love';
                loveText.textContent = 'love';
                
                // Random position all over the screen
                loveText.style.left = Math.random() * 100 + '%';
                loveText.style.top = Math.random() * 100 + '%';
                loveText.style.fontSize = (Math.random() * 200 + 300) + 'px';
                
                // Start falling immediately with pulsation - smoother timing
                const duration = Math.random() * 3 + 8; // 8-11 seconds for smoother movement
                loveText.style.animation = `fallDown ${duration}s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite, fontPulse ${Math.random() * 2 + 2}s ease-in-out infinite`;
                loveText.style.animationDelay = '0s';
                
                victoryScreen.appendChild(loveText);
                
                // Remove text after it falls off screen
                setTimeout(() => {
                    if (loveText.parentNode) {
                        loveText.parentNode.removeChild(loveText);
                    }
                }, (duration + 2) * 1000);
            }
            
            // Start continuous text creation immediately
            startContinuousTextCreation();
        }
        
        
        function startContinuousTextCreation() {
            const victoryScreen = document.getElementById('victoryScreen');
            
            function createNewText() {
                const loveText = document.createElement('div');
                loveText.className = 'victory-text love';
                loveText.textContent = 'love';
                
                // Random horizontal position, start from top
                loveText.style.left = Math.random() * 100 + '%';
                loveText.style.top = '-200px'; // Start above the screen
                loveText.style.fontSize = (Math.random() * 200 + 300) + 'px';
                
                // Fall down animation with variable speed - NO DELAY - smoother
                const duration = Math.random() * 3 + 8; // 8-11 seconds for smoother movement
                loveText.style.animation = `fallDown ${duration}s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite, fontPulse ${Math.random() * 2 + 2}s ease-in-out infinite`;
                loveText.style.animationDelay = '0s'; // Force no delay
                
                victoryScreen.appendChild(loveText);
                
                // Remove text after it falls off screen
                setTimeout(() => {
                    if (loveText.parentNode) {
                        loveText.parentNode.removeChild(loveText);
                    }
                }, (duration + 2) * 1000);
            }
            
            // Create new text every 0.4 seconds for smoother continuous falling
            const textInterval = setInterval(createNewText, 400);
            
            // Store interval ID for cleanup
            window.textInterval = textInterval;
        }
        
        function startHeartAnimation() {
            const heartSymbols = ['♥', '💖', '💕', '💗', '💝', '💘', '💞', '💓', '💔', '💟'];
            
            function createHeart() {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.textContent = heartSymbols[Math.floor(Math.random() * heartSymbols.length)];
                heart.style.left = Math.random() * 100 + '%';
                heart.style.animationDuration = (Math.random() * 2 + 3) + 's';
                heart.style.fontSize = (Math.random() * 15 + 20) + 'px';
                heart.style.opacity = Math.random() * 0.5 + 0.7;
                
                document.body.appendChild(heart);
                
                // Remove heart after animation
                setTimeout(() => {
                    if (heart.parentNode) {
                        heart.parentNode.removeChild(heart);
                    }
                }, 5000);
            }
            
            // Create hearts continuously - smoother timing
            const heartInterval = setInterval(createHeart, 200);
            
            // Store interval ID for cleanup
            window.heartInterval = heartInterval;
        }
        
        function restartGame() {
            // Stop heart animation
            if (window.heartInterval) {
                clearInterval(window.heartInterval);
            }
            
            // Stop text creation
            if (window.textInterval) {
                clearInterval(window.textInterval);
            }
            
            // Remove all existing hearts
            const hearts = document.querySelectorAll('.heart');
            hearts.forEach(heart => heart.remove());
            
            // Remove all victory texts
            const victoryTexts = document.querySelectorAll('.victory-text');
            victoryTexts.forEach(text => text.remove());
            
            // Reset game state
            currentDistance = 20;
            
            // Go back to game screen
            showScreen('game');
            updateDotPositions();
            updateScoreDisplay();
            showRandomQuestion();
        }

        // Initialize face detection
        async function initializeFaceDetection() {
            try {
                faceDetector = new FaceDetection({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection@0.4/${file}`
                });
                await faceDetector.setOptions({
                    model: 'short',
                    minDetectionConfidence: 0.5,
                });
                console.log('Face detection initialized');
            } catch (error) {
                console.error('Error initializing face detection:', error);
                // Fallback to simple center crop if face detection fails
            }
        }

        // Photo upload and processing functions
        function handlePhotoUpload(dotNumber, input) {
            const file = input.files[0];
            if (file) {
                uploadedPhotos[`photo${dotNumber}`] = file;
                autoCropPhoto(file, dotNumber);
            }
        }

        async function autoCropPhoto(file, dotNumber) {
            showProcessingModal(`Обработка фото ${dotNumber}...`);
            
            try {
                const img = new Image();
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    img.onload = async function() {
                        try {
                            let cropData;
                            
                            if (faceDetector) {
                                // Try face detection first
                                cropData = await detectAndCropFace(img);
                            }
                            
                            if (!cropData) {
                                // Fallback to center crop
                                cropData = getCenterCrop(img);
                            }
                            
                            const croppedFile = await cropImageToFile(img, cropData);
                            uploadedPhotos[`photo${dotNumber}`] = croppedFile;
                            
                            hideProcessingModal();
                            checkPhotosReady();
                            
                        } catch (error) {
                            console.error('Error processing photo:', error);
                            // Fallback to center crop
                            const cropData = getCenterCrop(img);
                            const croppedFile = await cropImageToFile(img, cropData);
                            uploadedPhotos[`photo${dotNumber}`] = croppedFile;
                            
                            hideProcessingModal();
                            checkPhotosReady();
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error reading file:', error);
                hideProcessingModal();
            }
        }

        async function detectAndCropFace(img) {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const detections = await faceDetector.detect(canvas);
                
                if (detections && detections.length > 0) {
                    // Get the largest face
                    const largestFace = detections.reduce((largest, current) => {
                        const currentArea = current.boundingBox.width * current.boundingBox.height;
                        const largestArea = largest.boundingBox.width * largest.boundingBox.height;
                        return currentArea > largestArea ? current : largest;
                    });
                    
                    const bbox = largestFace.boundingBox;
                    
                    // Calculate face center
                    const faceCenterX = bbox.x + bbox.width / 2;
                    const faceCenterY = bbox.y + bbox.height / 2;
                    
                    // Create square crop centered on face
                    const cropSize = Math.max(bbox.width, bbox.height) * 1.8; // 80% larger than face
                    const halfSize = cropSize / 2;
                    
                    // Center the crop on the face
                    const x = Math.max(0, Math.min(img.width - cropSize, faceCenterX - halfSize));
                    const y = Math.max(0, Math.min(img.height - cropSize, faceCenterY - halfSize));
                    const width = Math.min(cropSize, img.width - x);
                    const height = Math.min(cropSize, img.height - y);
                    
                    return { x, y, width, height };
                }
            } catch (error) {
                console.error('Face detection error:', error);
            }
            return null;
        }

        function getCenterCrop(img) {
            // Fallback: crop center square of the image
            const cropSize = Math.min(img.width, img.height) * 0.8; // 80% of smaller dimension
            const x = (img.width - cropSize) / 2;
            const y = (img.height - cropSize) / 2;
            
            return { x, y, width: cropSize, height: cropSize };
        }

        async function cropImageToFile(img, cropData) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Standard size for all faces (square)
            const standardSize = 200; // 200x200 pixels for all faces
            canvas.width = standardSize;
            canvas.height = standardSize;
            
            // Draw cropped portion scaled to standard size
            ctx.drawImage(
                img,
                cropData.x, cropData.y, cropData.width, cropData.height,
                0, 0, standardSize, standardSize
            );
            
            // Convert to blob
            return new Promise((resolve) => {
                canvas.toBlob(function(blob) {
                    const croppedFile = new File([blob], `cropped_photo.jpg`, { type: 'image/jpeg' });
                    resolve(croppedFile);
                }, 'image/jpeg', 0.9);
            });
        }


        function showProcessingModal(text) {
            const modal = document.getElementById('processingModal');
            const textElement = document.getElementById('processingText');
            textElement.textContent = text;
            modal.style.display = 'flex';
        }

        function hideProcessingModal() {
            const modal = document.getElementById('processingModal');
            modal.style.display = 'none';
        }

        function checkPhotosReady() {
            const processBtn = document.getElementById('processBtn');
            if (uploadedPhotos.photo1 && uploadedPhotos.photo2) {
                processBtn.disabled = false;
                processBtn.textContent = 'Process Photos';
            } else {
                processBtn.disabled = true;
                processBtn.textContent = 'Upload Both Photos';
            }
        }

        function processPhotos() {
            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.textContent = 'Processing...';

            // Simulate photo processing (in a real app, you'd use AI/ML services)
            setTimeout(() => {
                displayProcessedPhotos();
                processBtn.textContent = 'Photos Processed!';
                processBtn.style.backgroundColor = '#4CAF50';
            }, 2000);
        }

        function displayProcessedPhotos() {
            // Create image elements for the processed photos
            const person1Img = document.getElementById('person1');
            const person2Img = document.getElementById('person2');

            // For demo purposes, we'll use the uploaded photos directly
            // In a real implementation, you'd use AI to extract people from photos
            if (uploadedPhotos.photo1) {
                const reader1 = new FileReader();
                reader1.onload = function(e) {
                    person1Img.src = e.target.result;
                    person1Img.style.display = 'block';
                };
                reader1.readAsDataURL(uploadedPhotos.photo1);
            } else {
                // Hide photo if not uploaded
                person1Img.style.display = 'none';
            }

            if (uploadedPhotos.photo2) {
                const reader2 = new FileReader();
                reader2.onload = function(e) {
                    person2Img.src = e.target.result;
                    person2Img.style.display = 'block';
                };
                reader2.readAsDataURL(uploadedPhotos.photo2);
            } else {
                // Hide photo if not uploaded
                person2Img.style.display = 'none';
            }
        }

        // Screen management functions
        function showScreen(screenName) {
            // Hide all screens
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('kissingScreen').style.display = 'none';
            document.getElementById('fighterScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('endScreen').style.display = 'none';
            document.getElementById('victoryScreen').style.display = 'none';
            document.getElementById('statsScreen').style.display = 'none';
            
            // Show the requested screen
            switch(screenName) {
                case 'welcome':
                    document.getElementById('welcomeScreen').style.display = 'flex';
                    break;
                case 'kissing':
                    document.getElementById('kissingScreen').style.display = 'flex';
                    break;
                case 'fighter':
                    document.getElementById('fighterScreen').style.display = 'flex';
                    break;
                case 'game':
                    document.getElementById('gameScreen').style.display = 'flex';
                    break;
                case 'end':
                    document.getElementById('endScreen').style.display = 'flex';
                    break;
                case 'victory':
                    document.getElementById('victoryScreen').style.display = 'flex';
                    break;
                case 'stats':
                    document.getElementById('statsScreen').style.display = 'flex';
                    break;
            }
            currentScreen = screenName;
        }

        // Game flow functions
        function showKissingScreenWithHearts() {
            // Show heart animations
            showHeartAnimation();
            // Then show kissing screen
            setTimeout(() => {
                showScreen('kissing');
            }, 1500);
        }

        function showKissingScreen() {
            showScreen('kissing');
        }

        function showQuestionAndButton() {
            // Change text to "точно?" and button to "да" simultaneously
            const kissingText = document.getElementById('kissingText');
            const kissButton = document.getElementById('kissButton');
            
            kissingText.textContent = 'точно?';
            kissButton.textContent = 'да';
            kissButton.onclick = showQuestionMarksAndKisses;
            
            // Show falling question marks from bottom
            showQuestionMarkAnimation();
        }

        function showQuestionMarksAndKisses() {
            // Stop the continuous question mark animation
            if (questionMarkInterval) {
                clearInterval(questionMarkInterval);
                questionMarkInterval = null;
            }
            
            // Remove all existing question mark elements
            const questionMarkElements = document.querySelectorAll('.question-mark-animation');
            questionMarkElements.forEach(element => {
                if (element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            });
            
            // Show kiss animations immediately
            showKissAnimation();
            
            // Keep text and button visible for 1.5 seconds, then transition
            setTimeout(() => {
                showScreen('fighter');
            }, 1500);
        }

        function startGameWithKisses() {
            // Show kiss animations
            showKissAnimation();
            // Then start game
            setTimeout(() => {
                showScreen('fighter');
            }, 1500);
        }

        function startGame() {
            showScreen('fighter');
        }

        function handleFighterUpload(fighterNumber, input) {
            const file = input.files[0];
            if (file) {
                uploadedPhotos[`photo${fighterNumber}`] = file;
                autoCropPhoto(file, fighterNumber);
            } else {
                // Clear the photo if no file selected
                uploadedPhotos[`photo${fighterNumber}`] = null;
                // Hide the photo display
                const photoElement = document.getElementById(`person${fighterNumber}`);
                if (photoElement) {
                    photoElement.style.display = 'none';
                }
            }
            checkFightersReady();
        }

        function updateFighterName(fighterNumber, input) {
            fighterNames[`name${fighterNumber}`] = input.value.trim();
            checkFightersReady();
        }


        function checkFightersReady() {
            const startBtn = document.getElementById('startGameBtn');
            if (fighterNames.name1 && fighterNames.name2) {
                startBtn.disabled = false;
                startBtn.textContent = 'Начать путь космической любви!';
            } else {
                startBtn.disabled = true;
                startBtn.textContent = 'Введите имена обоих бойцов';
            }
        }

        function beginGame() {
            // Initialize player stats with names
            playerStats.player1.name = fighterNames.name1;
            playerStats.player2.name = fighterNames.name2;
            playerStats.player1.correct = 0;
            playerStats.player1.total = 0;
            playerStats.player2.correct = 0;
            playerStats.player2.total = 0;
            
            // Show mixed heart animation
            showMixedHeartAnimation();
            // Then start game
            setTimeout(() => {
                showScreen('game');
                displayProcessedPhotos();
                updateDotPositions();
                updateScoreDisplay();
                showRandomQuestion();
            }, 1500);
        }

        function showRandomQuestion() {
            const questionDisplay = document.getElementById('questionDisplay');
            const questionHeader = document.getElementById('questionHeader');
            let newQuestion;
            
            // Make sure we don't show the same question twice in a row
            do {
                newQuestion = questions[Math.floor(Math.random() * questions.length)];
            } while (newQuestion === currentQuestion && questions.length > 1);
            
            // Alternate between the two names
            const currentName = currentQuestionIndex % 2 === 0 ? fighterNames.name1 : fighterNames.name2;
            currentQuestionIndex++;
            
            // Replace "партнёр" with the actual name using proper declension
            const personalizedQuestion = personalizeQuestion(newQuestion, currentName);
            
            // Clear any existing fade timeout to ensure consistent timing
            if (headerFadeTimeout) {
                clearTimeout(headerFadeTimeout);
            }
            
            // Reset and update question header
            questionHeader.className = 'question-header'; // Remove fade-out class
            questionHeader.style.opacity = '1'; // Reset opacity
            questionHeader.style.animation = 'none'; // Reset animation
            questionHeader.textContent = `Вопрос для ${currentName}`;
            
            // Force reflow to ensure reset is applied
            questionHeader.offsetHeight;
            
            // Start fade-out animation after exactly 4 seconds
            headerFadeTimeout = setTimeout(() => {
                questionHeader.classList.add('fade-out');
                // Ensure the animation starts
                questionHeader.style.animation = 'fadeOut 1s ease-out forwards';
            }, 4000);
            
            currentQuestion = newQuestion;
            questionDisplay.textContent = personalizedQuestion;
        }

        function showAnswerAnimation(type) {
            const gameScreen = document.getElementById('gameScreen');
            const animation = document.createElement('div');
            
            if (type === 'heart') {
                animation.className = 'answer-heart';
                animation.textContent = '♥';
            } else if (type === 'broken-heart') {
                animation.className = 'answer-broken-heart';
                animation.textContent = '💔';
            }
            
            // Position animation randomly around the center
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            const randomX = centerX + (Math.random() - 0.5) * 200;
            const randomY = centerY + (Math.random() - 0.5) * 100;
            
            animation.style.left = randomX + 'px';
            animation.style.top = randomY + 'px';
            
            gameScreen.appendChild(animation);
            
            // Remove animation after it completes
            setTimeout(() => {
                if (animation.parentNode) {
                    animation.parentNode.removeChild(animation);
                }
            }, 2000);
        }

        function showHeartAnimation() {
            // Create multiple hearts that persist across screens
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.className = 'answer-heart';
                    heart.textContent = '♥';
                    heart.style.position = 'fixed';
                    heart.style.zIndex = '1003';
                    
                    // Position randomly around the screen
                    const randomX = Math.random() * window.innerWidth;
                    const randomY = Math.random() * window.innerHeight;
                    
                    heart.style.left = randomX + 'px';
                    heart.style.top = randomY + 'px';
                    
                    document.body.appendChild(heart);
                    
                    // Remove after animation
                    setTimeout(() => {
                        if (heart.parentNode) {
                            heart.parentNode.removeChild(heart);
                        }
                    }, 2000);
                }, i * 120);
            }
        }

        function showQuestionMarkAnimation() {
            // Clear any existing interval
            if (questionMarkInterval) {
                clearInterval(questionMarkInterval);
            }
            
            // Create initial batch of question marks and doubt emojis (like hearts on welcome screen)
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    createQuestionMarkElement();
                }, i * 120);
            }
            
            // Start continuous creation of falling elements (slower)
            questionMarkInterval = setInterval(() => {
                createQuestionMarkElement();
            }, 800); // Create new element every 800ms (slower)
        }
        
        function createQuestionMarkElement() {
            const element = document.createElement('div');
            element.className = 'question-mark-animation';
            
            // Randomly choose between question mark and doubt emoji
            const isDoubt = Math.random() < 0.5; // 50% chance for doubt emoji
            element.textContent = isDoubt ? '🤔' : '?';
            
            element.style.position = 'fixed';
            element.style.zIndex = '1003';
            
            // Position randomly around the screen (like hearts on welcome screen)
            const randomX = Math.random() * window.innerWidth;
            const randomY = Math.random() * window.innerHeight;
            
            element.style.left = randomX + 'px';
            element.style.top = randomY + 'px';
            
            document.body.appendChild(element);
            
            // Remove after animation (same duration as hearts)
            setTimeout(() => {
                if (element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            }, 2000);
        }

        function showKissAnimation() {
            // Create multiple kisses that persist across screens
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const kiss = document.createElement('div');
                    kiss.className = 'kiss-animation';
                    kiss.textContent = '💋';
                    kiss.style.position = 'fixed';
                    kiss.style.zIndex = '1003';
                    
                    // Position randomly around the screen
                    const randomX = Math.random() * window.innerWidth;
                    const randomY = Math.random() * window.innerHeight;
                    
                    kiss.style.left = randomX + 'px';
                    kiss.style.top = randomY + 'px';
                    
                    document.body.appendChild(kiss);
                    
                    // Remove after animation
                    setTimeout(() => {
                        if (kiss.parentNode) {
                            kiss.parentNode.removeChild(kiss);
                        }
                    }, 2000);
                }, i * 120);
            }
        }

        function showMixedHeartAnimation() {
            // Create mixed hearts (regular and broken) that persist across screens
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    
                    // Randomly choose between regular heart and broken heart
                    const isBroken = Math.random() < 0.4; // 40% chance for broken heart
                    
                    if (isBroken) {
                        heart.className = 'answer-broken-heart';
                        heart.textContent = '💔';
                    } else {
                        heart.className = 'answer-heart';
                        heart.textContent = '♥';
                    }
                    
                    heart.style.position = 'fixed';
                    heart.style.zIndex = '1003';
                    
                    // Position randomly around the screen
                    const randomX = Math.random() * window.innerWidth;
                    const randomY = Math.random() * window.innerHeight;
                    
                    heart.style.left = randomX + 'px';
                    heart.style.top = randomY + 'px';
                    
                    document.body.appendChild(heart);
                    
                    // Remove after animation
                    setTimeout(() => {
                        if (heart.parentNode) {
                            heart.parentNode.removeChild(heart);
                        }
                    }, 2000);
                }, i * 120);
            }
        }

        function showStatsScreen() {
            // Stop heart animation
            if (window.heartInterval) {
                clearInterval(window.heartInterval);
            }
            
            // Stop text creation
            if (window.textInterval) {
                clearInterval(window.textInterval);
            }
            
            // Remove all existing hearts
            const hearts = document.querySelectorAll('.heart');
            hearts.forEach(heart => heart.remove());
            
            // Remove all victory texts
            const victoryTexts = document.querySelectorAll('.victory-text');
            victoryTexts.forEach(text => text.remove());
            
            // Calculate and display statistics
            displayPlayerStats();
            
            // Show statistics screen
            showScreen('stats');
        }

        function displayPlayerStats() {
            // Display player 1 stats
            const player1Photo = document.getElementById('player1StatPhoto');
            const player1Name = document.getElementById('player1StatName');
            const player1Percentage = document.getElementById('player1StatPercentage');
            const player1Details = document.getElementById('player1StatDetails');
            
            // Display player 2 stats
            const player2Photo = document.getElementById('player2StatPhoto');
            const player2Name = document.getElementById('player2StatName');
            const player2Percentage = document.getElementById('player2StatPercentage');
            const player2Details = document.getElementById('player2StatDetails');
            
            // Calculate percentages
            const player1Percent = playerStats.player1.total > 0 ? 
                Math.round((playerStats.player1.correct / playerStats.player1.total) * 100) : 0;
            const player2Percent = playerStats.player2.total > 0 ? 
                Math.round((playerStats.player2.correct / playerStats.player2.total) * 100) : 0;
            
            // Set player 1 data
            if (uploadedPhotos.photo1) {
                const reader1 = new FileReader();
                reader1.onload = function(e) {
                    player1Photo.src = e.target.result;
                };
                reader1.readAsDataURL(uploadedPhotos.photo1);
            }
            player1Name.textContent = playerStats.player1.name;
            player1Percentage.textContent = `${player1Percent}%`;
            player1Details.textContent = `${playerStats.player1.correct} из ${playerStats.player1.total} правильных`;
            
            // Set player 2 data
            if (uploadedPhotos.photo2) {
                const reader2 = new FileReader();
                reader2.onload = function(e) {
                    player2Photo.src = e.target.result;
                };
                reader2.readAsDataURL(uploadedPhotos.photo2);
            }
            player2Name.textContent = playerStats.player2.name;
            player2Percentage.textContent = `${player2Percent}%`;
            player2Details.textContent = `${playerStats.player2.correct} из ${playerStats.player2.total} правильных`;
        }

        function restartFromBeginning() {
            // Reset game state
            currentDistance = 20;
            uploadedPhotos = { photo1: null, photo2: null };
            fighterNames = { name1: '', name2: '' };
            currentQuestionIndex = 0;
            
            // Reset player stats
            playerStats.player1 = { correct: 0, total: 0, name: '' };
            playerStats.player2 = { correct: 0, total: 0, name: '' };
            
            // Clear uploaded photos and names
            document.getElementById('fighter1').value = '';
            document.getElementById('fighter2').value = '';
            document.getElementById('name1').value = '';
            document.getElementById('name2').value = '';
            
            // Hide all photos
            document.getElementById('person1').style.display = 'none';
            document.getElementById('person2').style.display = 'none';
            
            // Stop any animations
            if (window.heartInterval) {
                clearInterval(window.heartInterval);
            }
            if (window.textInterval) {
                clearInterval(window.textInterval);
            }
            
            // Remove all victory elements
            const hearts = document.querySelectorAll('.heart');
            hearts.forEach(heart => heart.remove());
            const victoryTexts = document.querySelectorAll('.victory-text');
            victoryTexts.forEach(text => text.remove());
            
            // Go back to welcome screen
            showScreen('welcome');
        }

        // Override the old checkPhotosReady function
        function checkPhotosReady() {
            checkFightersReady();
        }

        // Initialize the page
        window.addEventListener('load', async function() {
            showScreen('welcome');
            await initializeFaceDetection();
            // Initialize dot positions
            updateDotPositions();
        });
    </script>
</body>
</html>
